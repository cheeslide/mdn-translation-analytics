name: publish to gist

on:
  workflow_call:
    inputs:
      filename:
        required: true
        type: string

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4.1.8
        with:
          name: ${{ inputs.filename }}

      - name: Update Gist
        run: |
          head -n 10 ${{ inputs.filename }}
          
          cat "${{ inputs.filename }}" | jq -sR . >> content_temp
          
          json_data=$(jq -n --arg filename "${{ inputs.filename }}" --argfile content  "content_temp" \
            '{files: {($filename): {content: $content}}}')
          echo "$json_data" | cut -c 1-100 filename.txt
          
          response=$(curl -L \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.ACCOUNT_TOKEN_GIST }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "$json_data" \
            https://api.github.com/gists/${{ env.TARGET_GIST_ID }})
          
          # 检查 curl 的返回状态
          if [ $? -ne 0 ]; then
            echo "Error: Failed to update Gist."
            echo "$response"
            exit 1
          fi
          
          echo "Gist updated successfully: $response"
